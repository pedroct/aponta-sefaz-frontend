<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Add Time Action</title>
</head>
<body>
    <script>
        // VSS SDK j√° est√° dispon√≠vel no contexto da p√°gina Azure DevOps
        // Esperar que esteja pronto
        if (typeof VSS !== 'undefined') {
            initializeActionProvider();
        } else {
            // Se VSS ainda n√£o est√° dispon√≠vel, aguardar
            window.addEventListener('load', function() {
                if (typeof VSS !== 'undefined') {
                    initializeActionProvider();
                } else {
                    console.error('‚ùå VSS SDK n√£o est√° dispon√≠vel');
                }
            });
        }

        function initializeActionProvider() {
            VSS.init({ 
                usePlatformScripts: true,
                explicitNotifyLoaded: true
            });

        function initializeActionProvider() {
            VSS.init({ 
                usePlatformScripts: true,
                explicitNotifyLoaded: true
            });

            VSS.ready(function() {
                try {
                    console.log('‚úÖ Action Provider pronto');

                    // Registrar o action provider para o menu de contexto
                    VSS.register(VSS.getContributionId(), {
                        getMenuItems: function(context) {
                            console.log('üìã Contexto recebido:', context);
                            
                            // context.workItem tem os dados do item
                            if (!context || !context.workItem) {
                                console.warn('‚ö†Ô∏è Contexto de work item n√£o dispon√≠vel');
                                return [];
                            }

                            return [{
                                title: "‚è±Ô∏è Apontar Tempo",
                                action: function(actionContext) {
                                    console.log('üîî A√ß√£o clicada:', actionContext);
                                    const workItemId = actionContext.id || context.workItem.id;
                                    const workItemTitle = context.workItem.title || '';
                                    openAddTimeDialog(workItemId, workItemTitle);
                                },
                                disabled: false,
                                icon: "bowtie-icon bowtie-timer"
                            }];
                        }
                    });

                    console.log('‚úÖ Action Provider registrado');
                    VSS.notifyLoadSucceeded();

                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    VSS.notifyLoadFailed(error);
                }
            });
        }

        function openAddTimeDialog(workItemId, workItemTitle) {
            console.log('üîî Abrindo dialog para work item:', workItemId, workItemTitle);

            try {
                const extensionContext = VSS.getExtensionContext();
                const baseUri = extensionContext.baseUri;
                
                // Construir URL com par√¢metros
                const dialogUrl = `${baseUri}pages/addTimePopupDialog/index.html?workItemId=${workItemId}&taskTitle=${encodeURIComponent(workItemTitle)}`;

                console.log('üìç Dialog URL:', dialogUrl);

                const dialogOptions = {
                    title: "‚è±Ô∏è Apontar Tempo",
                    width: 600,
                    height: 700,
                    buttons: [],
                    resizable: false
                };

                // Abrir dialog via VSS Service
                VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                    return dialogService.openDialog(dialogUrl, dialogOptions);
                }).then(function(result) {
                    console.log('‚úÖ Dialog fechado com resultado:', result);
                }).catch(function(error) {
                    console.error('‚ùå Erro ao abrir dialog:', error);
                    alert('Erro ao abrir modal: ' + error.message);
                });

            } catch (error) {
                console.error('‚ùå Erro ao abrir dialog:', error);
                alert('Erro ao abrir modal: ' + error.message);
            }
        }
    </script>
</body>
</html>
