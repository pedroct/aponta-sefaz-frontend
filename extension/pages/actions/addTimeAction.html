<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Add Time Action</title>
    <script src="../../lib/VSS.SDK.min.js"></script>
</head>
<body>
    <script>
        // Inicializar imediatamente - o SDK j√° est√° carregado
        VSS.init({ 
            usePlatformScripts: true,
            explicitNotifyLoaded: true
        });

        VSS.ready(function() {
            try {
                console.log('‚úÖ Action Provider pronto');

                // Registrar o action provider para o menu de contexto
                VSS.register(VSS.getContributionId(), {
                    getMenuItems: function(context) {
                        console.log('üìã Contexto recebido:', context);
                        
                        // context.workItem ou context.workItemIds
                        if (!context) {
                            console.warn('‚ö†Ô∏è Contexto n√£o dispon√≠vel');
                            return [];
                        }

                        // Pegar o ID do work item
                        var workItemId = null;
                        var workItemTitle = '';
                        
                        if (context.workItem) {
                            workItemId = context.workItem.id;
                            workItemTitle = context.workItem.title || '';
                        } else if (context.workItemIds && context.workItemIds.length > 0) {
                            workItemId = context.workItemIds[0];
                        } else if (context.id) {
                            workItemId = context.id;
                        }

                        if (!workItemId) {
                            console.warn('‚ö†Ô∏è Work Item ID n√£o dispon√≠vel');
                            return [];
                        }

                        return [{
                            title: "‚è±Ô∏è Apontar Tempo",
                            action: function(actionContext) {
                                console.log('üîî A√ß√£o clicada:', actionContext);
                                openAddTimeDialog(workItemId, workItemTitle);
                            },
                            disabled: false,
                            icon: "bowtie-icon bowtie-timer"
                        }];
                    }
                });

                console.log('‚úÖ Action Provider registrado');
                VSS.notifyLoadSucceeded();

            } catch (error) {
                console.error('‚ùå Erro:', error);
                VSS.notifyLoadFailed(error.message || error);
            }
        });

        function openAddTimeDialog(workItemId, workItemTitle) {
            console.log('üîî Abrindo dialog para work item:', workItemId, workItemTitle);

            try {
                const extensionContext = VSS.getExtensionContext();
                const contributionId = extensionContext.publisherId + "." + extensionContext.extensionId + ".addApontaTimeDialog";
                
                console.log('üìç Contribution ID:', contributionId);

                const dialogOptions = {
                    title: "‚è±Ô∏è Apontar Tempo",
                    width: 600,
                    height: 700,
                    buttons: [],
                    resizable: false,
                    urlReplacementObject: {
                        workItemId: workItemId,
                        workItemTitle: encodeURIComponent(workItemTitle)
                    }
                };

                // Abrir dialog via VSS Service usando contribution
                VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                    return dialogService.openDialog(contributionId, dialogOptions);
                }).then(function(dialog) {
                    console.log('‚úÖ Dialog aberto');
                    dialog.getDialogResult().then(function(result) {
                        console.log('‚úÖ Dialog fechado com resultado:', result);
                    });
                }).catch(function(error) {
                    console.error('‚ùå Erro ao abrir dialog:', error);
                    alert('Erro ao abrir modal: ' + error.message);
                });

            } catch (error) {
                console.error('‚ùå Erro ao abrir dialog:', error);
                alert('Erro ao abrir modal: ' + error.message);
            }
        }
    </script>
</body>
</html>
