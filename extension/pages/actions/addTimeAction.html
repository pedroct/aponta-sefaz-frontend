<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Add Time Action</title>
    <script src="https://cdn.vsassets.io/bundles/vss-bundle-common-vB1nw9Al5u049FXIN_-LtaSyedknnPkw7ouPrDxTDowE="></script>
</head>
<body>
    <script>
        // Aguardar VSS SDK carregar do CDN
        (function waitForVSS() {
            if (typeof VSS !== 'undefined') {
                console.log('‚úÖ VSS SDK carregado');
                initializeActionProvider();
            } else {
                console.log('‚è≥ Aguardando VSS SDK...');
                setTimeout(waitForVSS, 50);
            }
        })();

        function initializeActionProvider() {
            VSS.init({ 
                usePlatformScripts: true,
                explicitNotifyLoaded: true
            });

            VSS.ready(function() {
                try {
                    console.log('‚úÖ Action Provider pronto');

                    // Registrar o action provider para o menu de contexto
                    VSS.register(VSS.getContributionId(), {
                        getMenuItems: function(context) {
                            console.log('üìã Contexto recebido:', context);
                            
                            // context.workItem tem os dados do item
                            if (!context || !context.workItem) {
                                console.warn('‚ö†Ô∏è Contexto de work item n√£o dispon√≠vel');
                                return [];
                            }

                            return [{
                                title: "‚è±Ô∏è Apontar Tempo",
                                action: function(actionContext) {
                                    console.log('üîî A√ß√£o clicada:', actionContext);
                                    const workItemId = actionContext.id || context.workItem.id;
                                    const workItemTitle = context.workItem.title || '';
                                    openAddTimeDialog(workItemId, workItemTitle);
                                },
                                disabled: false,
                                icon: "bowtie-icon bowtie-timer"
                            }];
                        }
                    });

                    console.log('‚úÖ Action Provider registrado');
                    VSS.notifyLoadSucceeded();

                } catch (error) {
                    console.error('‚ùå Erro:', error);
                    VSS.notifyLoadFailed(error);
                }
            });
        }

        function openAddTimeDialog(workItemId, workItemTitle) {
            console.log('üîî Abrindo dialog para work item:', workItemId, workItemTitle);

            try {
                const extensionContext = VSS.getExtensionContext();
                const contributionId = extensionContext.publisherId + "." + extensionContext.extensionId + ".addApontaTimeDialog";
                
                console.log('üìç Contribution ID:', contributionId);

                const dialogOptions = {
                    title: "‚è±Ô∏è Apontar Tempo",
                    width: 600,
                    height: 700,
                    buttons: [],
                    resizable: false,
                    urlReplacementObject: {
                        workItemId: workItemId,
                        workItemTitle: encodeURIComponent(workItemTitle)
                    }
                };

                // Abrir dialog via VSS Service usando contribution
                VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                    return dialogService.openDialog(contributionId, dialogOptions);
                }).then(function(dialog) {
                    console.log('‚úÖ Dialog aberto');
                    dialog.getDialogResult().then(function(result) {
                        console.log('‚úÖ Dialog fechado com resultado:', result);
                    });
                }).catch(function(error) {
                    console.error('‚ùå Erro ao abrir dialog:', error);
                    alert('Erro ao abrir modal: ' + error.message);
                });

            } catch (error) {
                console.error('‚ùå Erro ao abrir dialog:', error);
                alert('Erro ao abrir modal: ' + error.message);
            }
        }
    </script>
</body>
</html>
