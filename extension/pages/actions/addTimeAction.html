<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Apontar Tempo</title>
    <script type="text/javascript" src="../../lib/VSS.SDK.min.js"></script>
</head>
<body>
    <script type="text/javascript">
        // Inicializa√ß√£o simples como o 7pace faz
        VSS.init();

        // Fun√ß√£o para extrair o ID do work item (cobre todos os cen√°rios)
        function getWorkItemId(actionContext) {
            console.log("üîç Aponta: Extraindo ID de:", actionContext);
            
            // Do contexto direto (workItemId no contexto principal)
            if (actionContext.workItemId) {
                console.log("‚úÖ Aponta: ID encontrado em workItemId:", actionContext.workItemId);
                return actionContext.workItemId;
            }
            // Do board (clique direto no card)
            if (actionContext.id) {
                console.log("‚úÖ Aponta: ID encontrado em id:", actionContext.id);
                return actionContext.id;
            }
            // Do backlog (sele√ß√£o m√∫ltipla)
            if (actionContext.workItemIds && actionContext.workItemIds.length > 0) {
                if (actionContext.workItemIds.length === 1) {
                    console.log("‚úÖ Aponta: ID encontrado em workItemIds[0]:", actionContext.workItemIds[0]);
                    return actionContext.workItemIds[0];
                } else {
                    alert("Por favor, selecione apenas um work item para apontar tempo.");
                    return null;
                }
            }
            console.warn("‚ö†Ô∏è Aponta: Nenhum ID encontrado no contexto");
            return null;
        }

        // Provider do menu de contexto - seguindo padr√£o 7pace
        var apontaContextMenuItems = (function() {
            return {
                getMenuItems: function(context) {
                    console.log("üìã Aponta: getMenuItems chamado com contexto:", context);
                    
                    var menuItems = [{
                        text: "Apontar Tempo",
                        title: "Clique para registrar tempo neste work item",
                        description: "Registrar horas trabalhadas neste work item",
                        icon: "/images/icon-16.png",
                        disabled: false,
                        action: function(actionContext) {
                            console.log("üîî Aponta: A√ß√£o clicada!", actionContext);
                            
                            // Usar o contexto principal se actionContext n√£o tiver o ID
                            var workItemId = getWorkItemId(actionContext) || getWorkItemId(context);
                            
                            if (!workItemId) {
                                alert("Erro: Work Item n√£o encontrado");
                                return;
                            }

                            console.log("üìç Aponta: Abrindo dialog para Work Item ID:", workItemId);

                            VSS.ready().then(function() {
                                VSS.getService(VSS.ServiceIds.Dialog).then(function(dialogService) {
                                    var extensionCtx = VSS.getExtensionContext();
                                    
                                    // Montar contribution ID completo
                                    var contributionId = extensionCtx.publisherId + 
                                        "." + extensionCtx.extensionId + 
                                        ".addApontaTimeDialog";
                                    
                                    console.log("üìç Aponta: Contribution ID:", contributionId);

                                    // Op√ß√µes do dialog
                                    var dialogOptions = {
                                        title: "Apontar Tempo",
                                        width: 500,
                                        height: 600,
                                        resizable: false,
                                        buttons: null,
                                        urlReplacementObject: { id: workItemId }
                                    };

                                    // Abrir o dialog
                                    dialogService.openDialog(contributionId, dialogOptions).then(function(dialog) {
                                        console.log("‚úÖ Aponta: Dialog aberto com sucesso");
                                    }).catch(function(error) {
                                        console.error("‚ùå Aponta: Erro ao abrir dialog:", error);
                                        alert("Erro ao abrir formul√°rio: " + (error.message || error));
                                    });
                                }).catch(function(error) {
                                    console.error("‚ùå Aponta: Erro ao obter DialogService:", error);
                                });
                            });
                        }
                    }];
                    
                    console.log("üìã Aponta: Retornando menu items:", menuItems);
                    return menuItems;
                }
            };
        })();

        // Registrar com a string fixa que corresponde ao registeredObjectId no manifest
        VSS.register("ApontaContextMenuItems", apontaContextMenuItems);
        
        console.log("‚úÖ Aponta: Action Provider registrado como 'ApontaContextMenuItems'");
    </script>
</body>
</html>
</body>
</html>
