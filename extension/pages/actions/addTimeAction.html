<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Apontar Tempo</title>
    <script type="text/javascript" src="../../lib/VSS.SDK.min.js"></script>
</head>
<body>
    <script type="text/javascript">
        // Inicializa√ß√£o simples como o 7pace faz
        VSS.init();

        // Fun√ß√£o para extrair o ID do work item (cobre todos os cen√°rios)
        function getWorkItemId(actionContext) {
            // Do board (clique direto no card)
            if (actionContext.id) {
                return actionContext.id;
            }
            // Do Work Item Form
            if (actionContext.workItemId) {
                return actionContext.workItemId;
            }
            // Do backlog (sele√ß√£o)
            if (actionContext.workItemIds && actionContext.workItemIds.length > 0) {
                if (actionContext.workItemIds.length === 1) {
                    return actionContext.workItemIds[0];
                } else {
                    alert("Por favor, selecione apenas um work item para apontar tempo.");
                    return null;
                }
            }
            return null;
        }

        // Provider do menu de contexto
        var apontaContextMenuItems = (function() {
            return {
                getMenuItems: async function(context) {
                    await VSS.ready();
                    
                    console.log("üìã Aponta: Contexto recebido:", context);

                    return [{
                        text: "‚è±Ô∏è Apontar Tempo",
                        title: "Clique para registrar tempo neste work item",
                        icon: "bowtie-icon bowtie-status-run",
                        action: async function(actionContext) {
                            console.log("üîî Aponta: A√ß√£o clicada:", actionContext);
                            
                            var workItemId = getWorkItemId(actionContext);
                            
                            if (!workItemId) {
                                alert("Erro: Work Item n√£o encontrado");
                                return;
                            }

                            console.log("üìç Aponta: Work Item ID:", workItemId);

                            await VSS.ready();
                            
                            try {
                                var dialogService = await VSS.getService(VSS.ServiceIds.Dialog);
                                var extensionCtx = VSS.getExtensionContext();
                                
                                // Montar contribution ID completo
                                var contributionId = extensionCtx.publisherId + 
                                    "." + extensionCtx.extensionId + 
                                    ".addApontaTimeDialog";
                                
                                console.log("üìç Aponta: Contribution ID:", contributionId);

                                // Op√ß√µes do dialog
                                var dialogOptions = {
                                    title: "‚è±Ô∏è Apontar Tempo",
                                    width: 500,
                                    height: 600,
                                    resizable: false,
                                    buttons: null,
                                    urlReplacementObject: { id: workItemId }
                                };

                                // Abrir o dialog
                                var dialog = await dialogService.openDialog(contributionId, dialogOptions);
                                console.log("‚úÖ Aponta: Dialog aberto com sucesso");
                                
                            } catch (error) {
                                console.error("‚ùå Aponta: Erro ao abrir dialog:", error);
                                alert("Erro ao abrir formul√°rio de apontamento: " + (error.message || error));
                            }
                        }
                    }];
                }
            };
        })();

        // Registrar com a string fixa que corresponde ao registeredObjectId no manifest
        VSS.register("ApontaContextMenuItems", apontaContextMenuItems);
        
        console.log("‚úÖ Aponta: Action Provider registrado como 'ApontaContextMenuItems'");
    </script>
</body>
</html>
