events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # Seguran√ßa
    server_tokens off;

    # Gzip
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # =====================================================
    # MAPA PARA DETECTAR ACESSO VIA AZURE DEVOPS
    # =====================================================
    
    # Verifica se a requisi√ß√£o tem par√¢metros de contexto Azure DevOps
    # ou se √© um asset est√°tico que precisa carregar
    map $arg_token $has_azure_token {
        default 0;
        "~.+" 1;
    }
    
    map $arg_organization $has_azure_org {
        default 0;
        "~.+" 1;
    }
    
    # Combina: tem token OU tem organization = contexto Azure DevOps
    map "$has_azure_token:$has_azure_org" $is_azure_context {
        default 0;
        "1:0" 1;
        "0:1" 1;
        "1:1" 1;
    }
    
    # Verifica referer do Azure DevOps
    map $http_referer $from_azure_devops {
        default 0;
        "~*dev\.azure\.com" 1;
        "~*visualstudio\.com" 1;
        "~*azure\.com" 1;
        "~*vsassets\.io" 1;
    }
    
    # Verifica se √© requisi√ß√£o de asset (js, css, imagens, etc)
    map $uri $is_static_asset {
        default 0;
        "~*\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$" 1;
        "~*/assets/" 1;
    }
    
    # Permite acesso se: tem contexto Azure OU vem do Azure DevOps OU √© asset est√°tico
    map "$is_azure_context:$from_azure_devops:$is_static_asset" $allow_access {
        default 0;
        "1:0:0" 1;
        "1:1:0" 1;
        "1:0:1" 1;
        "1:1:1" 1;
        "0:1:0" 1;
        "0:1:1" 1;
        "0:0:1" 1;
    }

    # =====================================================
    # UPSTREAMS
    # =====================================================

    # Produ√ß√£o
    upstream api_prod {
        server api-aponta-prod:8000;
        keepalive 32;
    }

    upstream frontend_prod {
        server fe-aponta-prod:80;
        keepalive 32;
    }

    # Staging
    upstream api_staging {
        server api-aponta-staging:8000;
        keepalive 32;
    }

    upstream frontend_staging {
        server fe-aponta-staging:80;
        keepalive 32;
    }

    # =====================================================
    # PRODU√á√ÉO - aponta.treit.com.br
    # =====================================================

    server {
        listen 80;
        server_name aponta.treit.com.br;

        # CloudFlare Real IP
        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 131.0.72.0/22;
        real_ip_header CF-Connecting-IP;

        # Frontend - com verifica√ß√£o de acesso
        location / {
            # Bloqueia acesso direto (sem contexto Azure DevOps)
            if ($allow_access = 0) {
                return 403 '<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Restrito - Aponta</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        h1 { font-size: 2em; margin-bottom: 0.5em; }
        p { font-size: 1.1em; opacity: 0.9; line-height: 1.6; }
        .icon { font-size: 4em; margin-bottom: 20px; }
        a { color: #fff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üîí</div>
        <h1>Acesso Restrito</h1>
        <p>Este sistema est√° dispon√≠vel apenas como extens√£o do <strong>Azure DevOps</strong>.</p>
        <p>Para acessar, abra o <a href="https://dev.azure.com" target="_blank">Azure DevOps</a> e utilize a extens√£o <strong>Aponta Projetos</strong>.</p>
    </div>
</body>
</html>';
            }

            proxy_pass http://frontend_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Headers para iframe Azure DevOps
            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;
        }

        # API - sempre requer token (j√° protegido pelo backend)
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://api_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check - sempre liberado
        location /health {
            proxy_pass http://api_prod/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /nginx-health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }

        # Swagger - liberado para desenvolvimento
        location /docs {
            proxy_pass http://api_prod/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://api_prod/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://api_prod/openapi.json;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }

    # HTTPS - Produ√ß√£o
    server {
        listen 443 ssl http2;
        server_name aponta.treit.com.br;

        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 131.0.72.0/22;
        real_ip_header CF-Connecting-IP;

        # Frontend - com verifica√ß√£o de acesso
        location / {
            if ($allow_access = 0) {
                return 403 '<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acesso Restrito - Aponta</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        h1 { font-size: 2em; margin-bottom: 0.5em; }
        p { font-size: 1.1em; opacity: 0.9; line-height: 1.6; }
        .icon { font-size: 4em; margin-bottom: 20px; }
        a { color: #fff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">üîí</div>
        <h1>Acesso Restrito</h1>
        <p>Este sistema est√° dispon√≠vel apenas como extens√£o do <strong>Azure DevOps</strong>.</p>
        <p>Para acessar, abra o <a href="https://dev.azure.com" target="_blank">Azure DevOps</a> e utilize a extens√£o <strong>Aponta Projetos</strong>.</p>
    </div>
</body>
</html>';
            }

            proxy_pass http://frontend_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;
        }

        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://api_prod;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /docs {
            proxy_pass http://api_prod/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://api_prod/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://api_prod/openapi.json;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /health {
            proxy_pass http://api_prod/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }

    # =====================================================
    # STAGING - staging-aponta.treit.com.br
    # =====================================================

    server {
        listen 80;
        server_name staging-aponta.treit.com.br;

        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 131.0.72.0/22;
        real_ip_header CF-Connecting-IP;

        # Staging - liberado para desenvolvimento
        location / {
            proxy_pass http://frontend_staging;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;
        }

        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://api_staging;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /docs {
            proxy_pass http://api_staging/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://api_staging/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://api_staging/openapi.json;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /health {
            proxy_pass http://api_staging/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }

    # HTTPS - Staging
    server {
        listen 443 ssl http2;
        server_name staging-aponta.treit.com.br;

        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384;

        set_real_ip_from 173.245.48.0/20;
        set_real_ip_from 103.21.244.0/22;
        set_real_ip_from 103.22.200.0/22;
        set_real_ip_from 103.31.4.0/22;
        set_real_ip_from 141.101.64.0/18;
        set_real_ip_from 108.162.192.0/18;
        set_real_ip_from 190.93.240.0/20;
        set_real_ip_from 188.114.96.0/20;
        set_real_ip_from 197.234.240.0/22;
        set_real_ip_from 198.41.128.0/17;
        set_real_ip_from 162.158.0.0/15;
        set_real_ip_from 104.16.0.0/13;
        set_real_ip_from 104.24.0.0/14;
        set_real_ip_from 172.64.0.0/13;
        set_real_ip_from 131.0.72.0/22;
        real_ip_header CF-Connecting-IP;

        # Staging - liberado para desenvolvimento  
        location / {
            proxy_pass http://frontend_staging;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;
        }

        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://api_staging;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Connection "";

            add_header Content-Security-Policy "frame-ancestors 'self' https://dev.azure.com https://*.visualstudio.com https://*.azure.com https://*.vsassets.io" always;
            add_header X-Content-Type-Options "nosniff" always;

            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        location /docs {
            proxy_pass http://api_staging/docs;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /redoc {
            proxy_pass http://api_staging/redoc;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /openapi.json {
            proxy_pass http://api_staging/openapi.json;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }

        location /health {
            proxy_pass http://api_staging/health;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
        }
    }
}
